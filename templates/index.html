<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ° ë„í† ë¦¬ ëª¨ìœ¼ê¸° ğŸŒ°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2C3E50 0%, #34495E 100%);
            color: #ECF0F1;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            padding: 20px;
        }

        .game-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .role-selection {
            text-align: center;
            margin-bottom: 30px;
        }

        .role-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .role-btn {
            padding: 20px 40px;
            font-size: 1.3rem;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            min-width: 150px;
        }

        .role-btn.teacher {
            background: #E74C3C;
            color: white;
        }

        .role-btn.teacher:hover {
            background: #C0392B;
            transform: translateY(-3px);
        }

        .role-btn.student {
            background: #3498DB;
            color: white;
        }

        .role-btn.student:hover {
            background: #2980B9;
            transform: translateY(-3px);
        }

        .teacher-panel {
            display: none;
            background: rgba(52, 73, 94, 0.9);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .student-panel {
            display: none;
            background: rgba(52, 73, 94, 0.9);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .category-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .category-btn {
            padding: 15px;
            font-size: 1.1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            background: #27AE60;
            color: white;
        }

        .category-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .room-code-input {
            margin-top: 20px;
            text-align: center;
        }

        .room-code-input input {
            padding: 12px 20px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            background: rgba(236, 240, 241, 0.9);
            color: #2C3E50;
            width: 200px;
            margin-right: 10px;
        }

        .word-input-section {
            margin-top: 20px;
        }

        .word-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: center;
            align-items: center;
        }

        .word-input-group input {
            padding: 8px 15px;
            font-size: 1rem;
            border: none;
            border-radius: 5px;
            background: rgba(236, 240, 241, 0.9);
            color: #2C3E50;
            width: 150px;
        }

        .word-input-group input[placeholder*="ëœ»"] {
            width: 200px;
        }

        .add-word-btn {
            padding: 8px 15px;
            font-size: 1rem;
            border: none;
            border-radius: 5px;
            background: #27AE60;
            color: white;
            cursor: pointer;
        }

        .add-word-btn:hover {
            background: #229954;
        }

        .word-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(44, 62, 80, 0.8);
            border-radius: 10px;
            padding: 15px;
        }

        .word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(52, 73, 94, 0.8);
            border-radius: 5px;
        }

        .remove-word-btn {
            padding: 5px 10px;
            font-size: 0.8rem;
            border: none;
            border-radius: 3px;
            background: #E74C3C;
            color: white;
            cursor: pointer;
        }

        .remove-word-btn:hover {
            background: #C0392B;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(44, 62, 80, 0.8);
            border-radius: 10px;
            border: 2px solid #3498DB;
        }

        .progress-info {
            font-size: 1.2rem;
            font-weight: bold;
            color: #F1C40F;
        }

        .score-info {
            font-size: 1.2rem;
            font-weight: bold;
            color: #27AE60;
        }

        .category-info {
            font-size: 1.2rem;
            font-weight: bold;
            color: #9B59B6;
        }

        .game-footer {
            text-align: center;
            margin-top: 20px;
        }

        .btn-danger {
            background: #E74C3C;
            color: white;
        }

        .btn-danger:hover {
            background: #C0392B;
            transform: translateY(-2px);
        }

        .game-card {
            background: rgba(52, 73, 94, 0.9);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-section {
            background: rgba(44, 62, 80, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #3498DB;
        }

        .word-display {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            letter-spacing: 5px;
            color: #F1C40F;
            margin-bottom: 10px;
        }

        .attempts {
            font-size: 1.2rem;
            color: #E74C3C;
            text-align: center;
        }

        .guessed-letters {
            font-size: 1rem;
            color: #BDC3C7;
            text-align: center;
        }

        .bridge-section {
            text-align: center;
            margin: 30px 0;
            position: relative;
        }

        .bridge-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .character-overlay {
            position: absolute;
            top: 25%;
            transform: translateY(-50%);
            width: 100px;
            height: 100px;
            transition: left 0.5s ease;
        }

        .character-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            mix-blend-mode: multiply;
            filter: contrast(1.1);
        }

        .treasure-overlay {
            position: absolute;
            top: 25%;
            right: 20px;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
        }

        .treasure-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .treasure-score {
            position: absolute;
            top: -30px;
            right: 0;
            background: #F1C40F;
            color: #2C3E50;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9rem;
            animation: bounce 0.5s ease-in-out;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .input-section {
            text-align: center;
            margin: 30px 0;
        }

        .input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .input-field {
            padding: 12px 20px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            background: rgba(236, 240, 241, 0.9);
            color: #2C3E50;
            width: 200px;
        }

        .btn {
            padding: 12px 25px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary {
            background: #27AE60;
            color: white;
        }

        .btn-primary:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #3498DB;
            color: white;
        }

        .btn-secondary:hover {
            background: #2980B9;
            transform: translateY(-2px);
        }

        .score-section {
            text-align: center;
            margin-top: 20px;
        }

        .score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #F1C40F;
        }

        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 30px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.3rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            z-index: 2000;
            min-width: 300px;
            backdrop-filter: blur(5px);
        }

        .message.success {
            background: rgba(39, 174, 96, 0.8);
            color: white;
        }

        .message.error {
            background: rgba(231, 76, 60, 0.8);
            color: white;
        }

        .message.warning {
            background: rgba(243, 156, 18, 0.8);
            color: white;
        }

        .quiz-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }

        .quiz-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2C3E50;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            min-width: 400px;
        }

        .quiz-options {
            display: grid;
            gap: 10px;
            margin-top: 20px;
        }

        .quiz-btn {
            padding: 15px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            background: #3498DB;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-btn:hover {
            background: #2980B9;
            transform: translateY(-2px);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: #ECF0F1;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #E74C3C;
        }

        .modal-body {
            text-align: center;
        }

        .modal-body p {
            font-size: 1.2rem;
            margin: 0;
        }

        .game-area {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .word-display {
                font-size: 1.5rem;
                letter-spacing: 3px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .input-field {
                width: 100%;
                max-width: 300px;
            }

            .role-buttons {
                flex-direction: column;
                align-items: center;
            }

            .category-selection {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="game-title">ğŸŒ° ë„í† ë¦¬ ëª¨ìœ¼ê¸° ğŸŒ°</h1>
        
        <!-- ì—­í•  ì„ íƒ -->
        <div class="role-selection">
            <h2>ì–´ë–»ê²Œ ì°¸ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>
            <div class="role-buttons">
                <button class="role-btn teacher" onclick="selectRole('teacher')">êµì‚¬ (ë¬¸ì œ/ë‹¨ì–´ ì…ë ¥)</button>
                <button class="role-btn student" onclick="selectRole('student')">í•™ìƒ (ê²Œì„ í”Œë ˆì´)</button>
            </div>
        </div>

                          <!-- êµì‚¬ íŒ¨ë„ -->
          <div id="teacherPanel" class="teacher-panel">
              <h3 style="text-align: center; margin-bottom: 20px;">êµì‚¬ ëª¨ë“œ - ì»¤ìŠ¤í…€ ë‹¨ì–´ ì…ë ¥</h3>
              <div class="word-input-section">
                  <div class="word-input-group">
                      <input type="text" id="wordInput" placeholder="ì˜ì–´ ë‹¨ì–´" maxlength="20">
                      <input type="text" id="meaningInput" placeholder="í•œêµ­ì–´ ëœ»" maxlength="50">
                      <button class="add-word-btn" onclick="addWord()">ì¶”ê°€</button>
                  </div>
              </div>
              <div class="word-list" id="wordList">
                  <p style="text-align: center; color: #BDC3C7;">ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>
              </div>
              <div id="messageArea"></div>
              <div style="text-align: center; margin-top: 20px;">
                  <button class="btn btn-primary" onclick="createRoom()">ë°© ìƒì„±í•˜ê¸°</button>
              </div>
              <div style="text-align: center; margin-top: 15px;">
                  <button class="btn btn-secondary" onclick="backToRoleSelection()">ëª¨ë“œ ì„ íƒí•˜ê¸°</button>
              </div>
          </div>

                          <!-- í•™ìƒ íŒ¨ë„ -->
          <div id="studentPanel" class="student-panel">
              <h3 style="text-align: center; margin-bottom: 20px;">í•™ìƒ ëª¨ë“œ - ê²Œì„ ì„ íƒ</h3>
              <div class="category-selection" id="categorySelection">
                  <!-- ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                  <button class="category-btn" onclick="selectCategory('fruit')">ê³¼ì¼</button>
                  <button class="category-btn" onclick="selectCategory('weather')">ë‚ ì”¨</button>
                  <button class="category-btn" onclick="selectCategory('food')">ìŒì‹</button>
                  <button class="category-btn" onclick="selectCategory('country')">ë‚˜ë¼</button>
                  <button class="category-btn" onclick="selectCategory('number')">ìˆ«ì</button>
                  <button class="category-btn" onclick="selectCategory('school')">í•™ìš©í’ˆ</button>
              </div>
              <div class="room-code-input">
                  <h4 style="margin-bottom: 15px;">ë˜ëŠ” ë°©ì½”ë“œë¡œ ì°¸ì—¬</h4>
                  <input type="text" id="roomCodeInput" placeholder="ë°©ì½”ë“œ ì…ë ¥" maxlength="6" style="text-transform: uppercase;">
                  <button class="btn btn-secondary" onclick="joinRoom()">ì°¸ì—¬í•˜ê¸°</button>
              </div>
              <div id="messageArea"></div>
              <div style="text-align: center; margin-top: 15px;">
                  <button class="btn btn-secondary" onclick="backToRoleSelection()">ëª¨ë“œ ì„ íƒí•˜ê¸°</button>
              </div>
          </div>

        <!-- ê²Œì„ ì˜ì—­ -->
        <div id="gameArea" class="game-area">
        <!-- ì§„í–‰ ìƒí™© ë° ì ìˆ˜ í‘œì‹œ -->
        <div class="game-header">
            <div class="progress-info">
                <span id="progressDisplay">1 / 8 ë¬¸ì œ</span>
            </div>
                <div class="category-info">
                    <span id="categoryDisplay">ì£¼ì œ: ê³¼ì¼</span>
            </div>
            <div class="score-info">
                <span id="totalScoreDisplay">ëˆ„ì  ì ìˆ˜: 0ì </span>
            </div>
        </div>
        
        <div class="game-card">
            <div class="game-info">
                <div class="info-section">
                    <div class="word-display" id="wordDisplay">_ _ _ _ _</div>
                    <div class="attempts" id="attemptsDisplay">ë‚¨ì€ ê¸°íšŒ: 4ë²ˆ</div>
                </div>
                <div class="info-section">
                    <div class="guessed-letters" id="guessedLetters">ì‹œë„í•œ ì•ŒíŒŒë²³: ì—†ìŒ</div>
                </div>
            </div>

            <div id="messageArea"></div>

            <div class="bridge-section">
                    <img id="bridgeImage" src="/static/images/ë‹¤ë¦¬1.jpg" alt="ë‹¤ë¦¬" class="bridge-image">
                
                <!-- ìºë¦­í„° ì˜¤ë²„ë ˆì´ -->
                <div class="character-overlay" id="characterOverlay">
                    <img src="/static/images/ì‚¬ëŒ.gif" alt="ìºë¦­í„°" class="character-image">
                </div>
                
                <!-- ë³´ë¬¼ ì˜¤ë²„ë ˆì´ -->
                <div class="treasure-overlay">
                    <span style="font-size: 2rem;">ğŸŒ°</span>
                    <div id="treasureScore" class="treasure-score" style="display: none;">+1ì </div>
                </div>
            </div>

            <div class="input-section">
                <div class="input-group">
                    <input type="text" id="userInput" class="input-field" placeholder="ì•ŒíŒŒë²³ ë˜ëŠ” ì „ì²´ ë‹¨ì–´ ì…ë ¥" maxlength="20">
                    <button onclick="processInput()" class="btn btn-primary">ì…ë ¥</button>
                         <button onclick="useHint()" class="btn btn-secondary" id="hintBtn">íŒíŠ¸ (2/2)</button>
                </div>
            </div>
        </div>
        
        <!-- ê²Œì„ ì¢…ë£Œ ë²„íŠ¼ -->
        <div class="game-footer">
            <button onclick="endGame()" class="btn btn-danger">ê²Œì„ ì¢…ë£Œ</button>
            </div>
        </div>
    </div>

    <!-- í€´ì¦ˆ ëª¨ë‹¬ -->
    <div id="quizModal" class="quiz-modal">
        <div class="quiz-content">
            <h2 id="quizQuestion">'apple'ì˜ ëœ»ì€ ë¬´ì—‡ì¼ê¹Œìš”?</h2>
            <div class="quiz-options" id="quizOptions">
                <!-- í€´ì¦ˆ ì˜µì…˜ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <!-- ê²Œì„ ì˜¤ë²„ ëª¨ë‹¬ -->
    <div id="gameOverModal" class="quiz-modal">
        <div class="quiz-content">
            <h2>ë‹¤ë¥¸ ë‹¨ì–´ì— ë„ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>
            <div class="quiz-options">
                <button class="quiz-btn" onclick="startNewGameAndCloseModal()">ì˜ˆ</button>
                <button class="quiz-btn" onclick="closeGameOverModal()">ì•„ë‹ˆìš”</button>
            </div>
        </div>
    </div>

    <!-- ê²Œì„ ì¢…ë£Œ ëª¨ë‹¬ -->
    <div id="gameEndModal" class="quiz-modal">
        <div class="quiz-content">
            <div class="modal-header">
                <h2 id="gameEndTitle">ê²Œì„ ì¢…ë£Œ</h2>
                                 <button class="close-btn" onclick="closeGameEndModalAndContinue()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="gameEndMessage">ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <div class="quiz-options" style="margin-top: 20px;">
                    <button class="quiz-btn" id="yesButton" onclick="startNewGameFromEndModal()">ì˜ˆ</button>
                    <button class="quiz-btn" id="noButton" onclick="closeGameEndModal()">ì•„ë‹ˆìš”</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let gameId = 'default';
        let currentGameState = null;
                 let selectedRole = null;
         let selectedCategory = null;
         let roomCode = null;
         let customWords = [];
         let hintCount = 2; // íŒíŠ¸ ì‚¬ìš© íšŸìˆ˜ (ì„œë²„ì—ì„œ ê´€ë¦¬ë¨)

                 // ì—­í•  ì„ íƒ
         function selectRole(role) {
             selectedRole = role;
             document.querySelector('.role-selection').style.display = 'none';
             
             if (role === 'teacher') {
                 document.getElementById('teacherPanel').style.display = 'block';
             } else {
                 document.getElementById('studentPanel').style.display = 'block';
                 loadCategories();
             }
         }

         // ì—­í•  ì„ íƒì°½ìœ¼ë¡œ ëŒì•„ê°€ê¸°
         function backToRoleSelection() {
             // í˜„ì¬ íŒ¨ë„ë“¤ ìˆ¨ê¸°ê¸°
             document.getElementById('teacherPanel').style.display = 'none';
             document.getElementById('studentPanel').style.display = 'none';
             
             // ì—­í•  ì„ íƒì°½ ë‹¤ì‹œ í‘œì‹œ
             document.querySelector('.role-selection').style.display = 'block';
             
             // ë³€ìˆ˜ ì´ˆê¸°í™”
             selectedRole = null;
             selectedCategory = null;
             roomCode = null;
             customWords = [];
         }

        // ì¹´í…Œê³ ë¦¬ ë¡œë“œ
        function loadCategories() {
            fetch('/get_categories')
                .then(response => response.json())
                .then(data => {
                    const categorySelection = document.getElementById('categorySelection');
                    categorySelection.innerHTML = '';
                    
                    // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ë§¤í•‘
                    const categoryNames = {
                        'fruit': 'ê³¼ì¼',
                        'weather': 'ë‚ ì”¨',
                        'food': 'ìŒì‹',
                        'country': 'ë‚˜ë¼',
                        'number': 'ìˆ«ì',
                        'school': 'í•™ìš©í’ˆ'
                    };
                    
                    console.log('ì¹´í…Œê³ ë¦¬ ë°ì´í„°:', data);
                    
                    data.forEach(category => {
                        const button = document.createElement('button');
                        button.className = 'category-btn';
                        button.textContent = categoryNames[category] || category;
                        button.onclick = () => selectCategory(category);
                        categorySelection.appendChild(button);
                        console.log('ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì¶”ê°€:', category);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('ì¹´í…Œê³ ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ë“¤ ì¶”ê°€
                    const categorySelection = document.getElementById('categorySelection');
                    const defaultCategories = ['fruit', 'weather', 'food', 'country', 'number', 'school'];
                    const categoryNames = {
                        'fruit': 'ê³¼ì¼',
                        'weather': 'ë‚ ì”¨',
                        'food': 'ìŒì‹',
                        'country': 'ë‚˜ë¼',
                        'number': 'ìˆ«ì',
                        'school': 'í•™ìš©í’ˆ'
                    };
                    
                    defaultCategories.forEach(category => {
                        const button = document.createElement('button');
                        button.className = 'category-btn';
                        button.textContent = categoryNames[category];
                        button.onclick = () => selectCategory(category);
                        categorySelection.appendChild(button);
                    });
                });
        }

        // ì¹´í…Œê³ ë¦¬ ì„ íƒ
        function selectCategory(category) {
            selectedCategory = category;
            // ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ë°© ì½”ë“œ ì´ˆê¸°í™” (ë‹¤ë¥¸ ê²Œì„ìœ¼ë¡œ ì „í™˜)
            roomCode = null;
            document.getElementById('studentPanel').style.display = 'none';
            startGame();
        }

        // ë°©ì½”ë“œë¡œ ì°¸ì—¬
        function joinRoom() {
            const roomCodeInput = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (!roomCodeInput) {
                showMessage('ë°©ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            fetch('/join_room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ room_code: roomCodeInput })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    roomCode = roomCodeInput;
                    document.getElementById('studentPanel').style.display = 'none';
                    startGame();
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('ë°© ì°¸ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });
        }

        // ë‹¨ì–´ ì¶”ê°€
        function addWord() {
            const wordInput = document.getElementById('wordInput');
            const meaningInput = document.getElementById('meaningInput');
            
            const word = wordInput.value.trim();
            const meaning = meaningInput.value.trim();
            
            if (!word || !meaning) {
                showMessage('ë‹¨ì–´ì™€ ëœ»ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            customWords.push([word, meaning]);
            updateWordList();
            
            wordInput.value = '';
            meaningInput.value = '';
            wordInput.focus();
        }

        // ë‹¨ì–´ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateWordList() {
            const wordList = document.getElementById('wordList');
            if (customWords.length === 0) {
                wordList.innerHTML = '<p style="text-align: center; color: #BDC3C7;">ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>';
                return;
            }
            
            wordList.innerHTML = '';
            customWords.forEach((wordPair, index) => {
                const wordItem = document.createElement('div');
                wordItem.className = 'word-item';
                wordItem.innerHTML = `
                    <span>${wordPair[0]} - ${wordPair[1]}</span>
                    <button class="remove-word-btn" onclick="removeWord(${index})">ì‚­ì œ</button>
                `;
                wordList.appendChild(wordItem);
            });
        }

        // ë‹¨ì–´ ì‚­ì œ
        function removeWord(index) {
            customWords.splice(index, 1);
            updateWordList();
        }

        // ë°© ìƒì„±
        function createRoom() {
            console.log('ë°© ìƒì„± í•¨ìˆ˜ í˜¸ì¶œë¨');  // ë””ë²„ê¹… ë¡œê·¸
            console.log('customWords:', customWords);  // ë””ë²„ê¹… ë¡œê·¸
            
            if (customWords.length === 0) {
                console.log('ë‹¨ì–´ê°€ ì—†ìŒ');  // ë””ë²„ê¹… ë¡œê·¸
                showMessage('ìµœì†Œ í•˜ë‚˜ì˜ ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            console.log('ì„œë²„ì— ìš”ì²­ ì „ì†¡ ì¤‘...');  // ë””ë²„ê¹… ë¡œê·¸
            console.log('ì „ì†¡í•  ë°ì´í„°:', JSON.stringify({ words: customWords }));  // ë””ë²„ê¹… ë¡œê·¸
            
            fetch('/create_room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ words: customWords })
            })
            .then(response => {
                console.log('ì„œë²„ ì‘ë‹µ ë°›ìŒ:', response);  // ë””ë²„ê¹… ë¡œê·¸
                console.log('ì‘ë‹µ ìƒíƒœ:', response.status);  // ë””ë²„ê¹… ë¡œê·¸
                console.log('ì‘ë‹µ í—¤ë”:', response.headers);  // ë””ë²„ê¹… ë¡œê·¸
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('ì‘ë‹µ ë°ì´í„°:', data);  // ë””ë²„ê¹… ë¡œê·¸
                if (data.success) {
                    console.log('ë°© ìƒì„± ì„±ê³µ:', data.room_code);  // ë””ë²„ê¹… ë¡œê·¸
                    showMessage(data.message, 'success');
                    
                    // í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹œë„ (ì™„ì „íˆ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
                    const roomCode = data.room_code;
                    
                    // í´ë¦½ë³´ë“œ ë³µì‚¬ í•¨ìˆ˜
                    const copyToClipboard = async (text) => {
                        try {
                            // ëª¨ë˜ ë¸Œë¼ìš°ì €ìš© í´ë¦½ë³´ë“œ API
                            if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                                await navigator.clipboard.writeText(text);
                                return true;
                            }
                            // êµ¬í˜• ë¸Œë¼ìš°ì €ìš© fallback
                            else if (window.clipboardData && window.clipboardData.setData) {
                                window.clipboardData.setData('text', text);
                                return true;
                            }
                            // document.execCommand fallback (deprecated but still works)
                            else {
                                const textArea = document.createElement('textarea');
                                textArea.value = text;
                                textArea.style.position = 'fixed';
                                textArea.style.left = '-999999px';
                                textArea.style.top = '-999999px';
                                document.body.appendChild(textArea);
                                textArea.focus();
                                textArea.select();
                                const successful = document.execCommand('copy');
                                document.body.removeChild(textArea);
                                return successful;
                            }
                        } catch (err) {
                            console.log('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                            return false;
                        }
                    };
                    
                    // í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹œë„
                    copyToClipboard(roomCode).then(success => {
                        if (success) {
                            showMessage('ë°©ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        } else {
                            showMessage(`ë°©ì½”ë“œ: ${roomCode} (ë³µì‚¬í•˜ë ¤ë©´ ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•˜ì„¸ìš”)`, 'success');
                        }
                    }).catch(err => {
                        console.log('í´ë¦½ë³´ë“œ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜:', err);
                        showMessage(`ë°©ì½”ë“œ: ${roomCode} (ë³µì‚¬í•˜ë ¤ë©´ ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•˜ì„¸ìš”)`, 'success');
                    });
                } else {
                    console.log('ë°© ìƒì„± ì‹¤íŒ¨:', data.error);  // ë””ë²„ê¹… ë¡œê·¸
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('ë°© ìƒì„± ì˜¤ë¥˜:', error);
                console.error('ì˜¤ë¥˜ ìƒì„¸:', error.message);  // ë””ë²„ê¹… ë¡œê·¸
                showMessage(`ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
            });
        }

                         // ê²Œì„ ì‹œì‘ (ìƒˆë¡œìš´ ê²Œì„ - ì ìˆ˜ ë¦¬ì…‹)
        function startGame() {
            document.getElementById('gameArea').style.display = 'block';
            
            fetch('/start_game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                 body: JSON.stringify({ 
                     game_id: gameId,
                     category: selectedCategory,
                     room_code: roomCode,
                     reset_score: true  // ìƒˆë¡œìš´ ê²Œì„ì´ë¯€ë¡œ ì ìˆ˜ ë¦¬ì…‹
                 })
            })
            .then(response => response.json())
            .then(data => {
                console.log('startGame ì„œë²„ ì‘ë‹µ:', data);
                if (data.success) {
                    currentGameState = data.game_state;
                    console.log('startGame currentGameState:', currentGameState);
                    console.log('startGame word:', currentGameState.word);
                    console.log('startGame word_display:', currentGameState.word_display);
                    // íŒíŠ¸ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
                    hintCount = currentGameState.hint_count || 2;
                    console.log('startGame - íŒíŠ¸ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”:', hintCount);
                    updateDisplay();
                    updateHintButton();
                } else {
                    console.error('startGame ì‹¤íŒ¨:', data);
                    showMessage('ê²Œì„ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('ê²Œì„ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });
        }

        // ìƒˆë¡œìš´ ë‹¨ì–´ ì‹œì‘ (íŒíŠ¸ ì¹´ìš´íŠ¸ ë¦¬ì…‹)
        function startNewWord() {
            fetch('/start_new_word', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    game_id: gameId,
                    category: selectedCategory,
                    room_code: roomCode
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentGameState = data.game_state;
                    console.log('ìƒˆ ë‹¨ì–´ ì‹œì‘ - ì„œë²„ ì‘ë‹µ:', data);
                    console.log('ìƒˆ ë‹¨ì–´ ì‹œì‘ - íŒíŠ¸ ì¹´ìš´íŠ¸:', currentGameState.hint_count);
                    // íŒíŠ¸ ì¹´ìš´íŠ¸ ëª…ì‹œì  ë¦¬ì…‹
                    hintCount = currentGameState.hint_count || 2;
                    console.log('ìƒˆ ë‹¨ì–´ ì‹œì‘ - ë¡œì»¬ íŒíŠ¸ ì¹´ìš´íŠ¸ ë¦¬ì…‹:', hintCount);
                    updateDisplay();
                    showMessage('ìƒˆë¡œìš´ ë‹¨ì–´ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('ìƒˆ ë‹¨ì–´ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });
        }

                         // íŒíŠ¸ ì‚¬ìš©
        function useHint() {
            if (!currentGameState) {
                showMessage('ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }
            
            if (!currentGameState.word) {
                console.error('currentGameState.wordê°€ undefinedì…ë‹ˆë‹¤:', currentGameState);
                showMessage('ê²Œì„ ìƒíƒœì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            if (hintCount <= 0) {
                showMessage('ì´ ë‹¨ì–´ì— ëŒ€í•œ íŒíŠ¸ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.', 'warning');
                return;
            }
             
             // í˜„ì¬ ë‹¨ì–´ì—ì„œ ê°€ì¥ ë§ì´ ë‚˜ì˜¤ëŠ” ì² ì ì°¾ê¸°
             const word = currentGameState.word.toLowerCase();
             const letterCount = {};
             
             // ê° ì² ìì˜ ë¹ˆë„ìˆ˜ ê³„ì‚°
             for (let letter of word) {
                 letterCount[letter] = (letterCount[letter] || 0) + 1;
             }
             
                           // ê°€ì¥ ë§ì´ ë‚˜ì˜¤ëŠ” ì² ì ì°¾ê¸° (ì´ë¯¸ ì¶”ì¸¡í•œ ì² ìëŠ” ì œì™¸)
              let maxLetter = '';
              let maxCount = 0;
              
              for (let letter in letterCount) {
                  // ì´ë¯¸ ì¶”ì¸¡í•œ ì² ìì¸ì§€ í™•ì¸
                  const isAlreadyGuessed = currentGameState.guessed_letters && currentGameState.guessed_letters.some(guessed => 
                      guessed.toLowerCase() === letter.toLowerCase()
                  );
                  
                  if (letterCount[letter] > maxCount && !isAlreadyGuessed) {
                      maxLetter = letter;
                      maxCount = letterCount[letter];
                  }
              }
             
             if (!maxLetter) {
                 showMessage('ë” ì´ìƒ ê³µê°œí•  íŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                 return;
             }
             
             // íŒíŠ¸ ì‚¬ìš© ìš”ì²­
             fetch('/use_hint', {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json',
                 },
                 body: JSON.stringify({ 
                     game_id: gameId
                 })
             })
             .then(response => response.json())
             .then(data => {
                console.log('useHint ì„œë²„ ì‘ë‹µ:', data);
                if (data.success) {
                    currentGameState = data.game_state;
                    hintCount = data.hint_count; // ì„œë²„ì—ì„œ ë°›ì€ íŒíŠ¸ ì¹´ìš´íŠ¸ ì‚¬ìš©
                    console.log('useHint - íŒíŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸:', hintCount);
                    updateDisplay();
                    updateHintButton();
                    // ì„œë²„ì—ì„œ ì œê³µí•œ íŒíŠ¸ ì •ë³´ ì‚¬ìš©
                    const hintLetter = data.hint;
                    const hintCountInWord = (currentGameState.word.match(new RegExp(hintLetter, 'gi')) || []).length;
                    showMessage(`íŒíŠ¸: '${hintLetter.toUpperCase()}'ê°€ ${hintCountInWord}ë²ˆ ë‚˜ì˜µë‹ˆë‹¤!`, 'success');
                } else {
                    showMessage(data.error, 'error');
                }
            })
             .catch(error => {
                 console.error('Error:', error);
                 showMessage('íŒíŠ¸ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
             });
         }
         
         // íŒíŠ¸ ë²„íŠ¼ ì—…ë°ì´íŠ¸
         function updateHintButton() {
             const hintBtn = document.getElementById('hintBtn');
             console.log('updateHintButton - íŒíŠ¸ ì¹´ìš´íŠ¸:', hintCount);
             hintBtn.textContent = `íŒíŠ¸ (${hintCount}/2)`;
             
             if (hintCount <= 0) {
                 hintBtn.disabled = true;
                 hintBtn.style.opacity = '0.5';
                 hintBtn.style.cursor = 'not-allowed';
                 console.log('updateHintButton - íŒíŠ¸ ë²„íŠ¼ ë¹„í™œì„±í™”ë¨');
             } else {
                 hintBtn.disabled = false;
                 hintBtn.style.opacity = '1';
                 hintBtn.style.cursor = 'pointer';
                 console.log('updateHintButton - íŒíŠ¸ ë²„íŠ¼ í™œì„±í™”ë¨');
             }
        }

        // ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬
        function processInput() {
            const input = document.getElementById('userInput').value.trim();
            if (!input) {
                showMessage('ì…ë ¥ì„ í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            fetch('/process_input', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    game_id: gameId,
                    input: input 
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('processInput ì„œë²„ ì‘ë‹µ:', data);
                if (data.error) {
                    showMessage(data.error, 'error');
                } else if (data.success) {
                    currentGameState = data.game_state;
                    console.log('processInput currentGameState:', currentGameState);
                    updateDisplay();
                    showMessage(data.message, 'success');

                    if (data.word_complete) {
                        // ì •ë‹µì„ ë§ì·„ì„ ë•Œ ì¦‰ì‹œ ìºë¦­í„°ë¥¼ ë³´ë¬¼ ìœ„ì¹˜ë¡œ ì´ë™
                        moveCharacterToTreasure();
                        // +1ì  í‘œì‹œ
                        showScorePoint();
                        // ì •ë‹µ ë©”ì‹œì§€ í‘œì‹œ
                        showMessage('ì •ë‹µì„ ë§ì¶”ì…¨ìŠµë‹ˆë‹¤.', 'success');
                        // 1ì´ˆ í›„ í€´ì¦ˆ í‘œì‹œ
                        setTimeout(() => showQuiz(), 1000);
                    } else if (data.game_over) {
                        setTimeout(() => {
                            showGameOverModal();
                        }, 2000);
                    }
                } else {
                    console.error('processInput ì‹¤íŒ¨:', data);
                    showMessage('ì…ë ¥ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('ì…ë ¥ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });

            document.getElementById('userInput').value = '';
        }

        // í€´ì¦ˆ í‘œì‹œ
        function showQuiz() {
            const modal = document.getElementById('quizModal');
            const question = document.getElementById('quizQuestion');
            const options = document.getElementById('quizOptions');

            question.textContent = `'${currentGameState.word}'ì˜ ëœ»ì€ ë¬´ì—‡ì¼ê¹Œìš”?`;

            const correctAnswer = currentGameState.meaning;
            
            if (!correctAnswer) {
                console.error('Meaning is missing from game state!');
                showMessage('í€´ì¦ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            // í˜„ì¬ ì¹´í…Œê³ ë¦¬ì˜ ëœ»ë“¤ì„ ê°€ì ¸ì™€ì„œ ì˜µì…˜ ìƒì„±
            // ê²Œì„ ìƒíƒœì—ì„œ ì¹´í…Œê³ ë¦¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            let category = currentGameState.category || selectedCategory || 'fruit';
            fetch(`/get_category_meanings?category=${category}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const categoryMeanings = data.meanings;
                        const wrongOptions = categoryMeanings.filter(meaning => meaning !== correctAnswer);
                        const selectedWrongOptions = [];
                        
                        const shuffledWrongOptions = [...wrongOptions].sort(() => Math.random() - 0.5);
                        
                        for (let i = 0; i < Math.min(2, shuffledWrongOptions.length); i++) {
                            selectedWrongOptions.push(shuffledWrongOptions[i]);
                        }
                        
                        const allOptions = [correctAnswer, ...selectedWrongOptions];
                        
                        for (let i = allOptions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [allOptions[i], allOptions[j]] = [allOptions[j], allOptions[i]];
                        }

                        options.innerHTML = '';
                        allOptions.forEach(option => {
                            const button = document.createElement('button');
                            button.className = 'quiz-btn';
                            button.textContent = option;
                            button.onclick = () => checkQuizAnswer(option);
                            options.appendChild(button);
                        });

                        modal.style.display = 'block';
                    } else {
                        // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ê³¼ì¼ ëœ»ë“¤ ì‚¬ìš©
                        const defaultOptions = ['ì‚¬ê³¼', 'ë°”ë‚˜ë‚˜', 'ì˜¤ë Œì§€', 'í¬ë„', 'ë”¸ê¸°', 'ìˆ˜ë°•', 'ë³µìˆ­ì•„', 'ë ˆëª¬', 'ì²´ë¦¬'];
                        const wrongOptions = defaultOptions.filter(option => option !== correctAnswer);
            const selectedWrongOptions = [];
                        
            const shuffledWrongOptions = [...wrongOptions].sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < Math.min(2, shuffledWrongOptions.length); i++) {
                selectedWrongOptions.push(shuffledWrongOptions[i]);
            }
            
            const allOptions = [correctAnswer, ...selectedWrongOptions];
            
            for (let i = allOptions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allOptions[i], allOptions[j]] = [allOptions[j], allOptions[i]];
            }
            
                        options.innerHTML = '';
                        allOptions.forEach(option => {
                            const button = document.createElement('button');
                            button.className = 'quiz-btn';
                            button.textContent = option;
                            button.onclick = () => checkQuizAnswer(option);
                            options.appendChild(button);
                        });

                        modal.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // ì—ëŸ¬ ì‹œ ê¸°ë³¸ ê³¼ì¼ ëœ»ë“¤ ì‚¬ìš©
                    const defaultOptions = ['ì‚¬ê³¼', 'ë°”ë‚˜ë‚˜', 'ì˜¤ë Œì§€', 'í¬ë„', 'ë”¸ê¸°', 'ìˆ˜ë°•', 'ë³µìˆ­ì•„', 'ë ˆëª¬', 'ì²´ë¦¬'];
                    const wrongOptions = defaultOptions.filter(option => option !== correctAnswer);
                    const selectedWrongOptions = [];
                    
                    const shuffledWrongOptions = [...wrongOptions].sort(() => Math.random() - 0.5);
                    
                    for (let i = 0; i < Math.min(2, shuffledWrongOptions.length); i++) {
                        selectedWrongOptions.push(shuffledWrongOptions[i]);
                    }
                    
                    const allOptions = [correctAnswer, ...selectedWrongOptions];
                    
                    for (let i = allOptions.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [allOptions[i], allOptions[j]] = [allOptions[j], allOptions[i]];
                    }

            options.innerHTML = '';
            allOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'quiz-btn';
                button.textContent = option;
                button.onclick = () => checkQuizAnswer(option);
                options.appendChild(button);
            });

            modal.style.display = 'block';
                });
        }

        // í€´ì¦ˆ ë‹µì•ˆ í™•ì¸
        function checkQuizAnswer(answer) {
            fetch('/check_quiz', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    game_id: gameId,
                    answer: answer 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('quizModal').style.display = 'none';
                    showMessage(data.message, data.correct ? 'success' : 'error');
                    
                    currentGameState.score = data.score;
                    updateDisplay();
                    
                    if (data.game_complete) {
                        setTimeout(() => {
                            showCompletionModal(data.completion_message, data.final_score);
                        }, 2000);
                    } else if (data.next_question) {
                        setTimeout(() => {
                            showMessage('ë‹¤ìŒ ë¬¸ì œë¡œ ì§„í–‰í•©ë‹ˆë‹¤...', 'warning');
                            setTimeout(startNewWord, 2000);
                        }, 2000);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('í€´ì¦ˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });
        }

        // í™”ë©´ ì—…ë°ì´íŠ¸
        function updateDisplay() {
            console.log('updateDisplay í˜¸ì¶œë¨ - currentGameState:', currentGameState);
            if (!currentGameState) {
                console.error('currentGameStateê°€ undefinedì…ë‹ˆë‹¤.');
                return;
            }

            // í•„ìˆ˜ ì†ì„±ë“¤ì´ ìˆëŠ”ì§€ í™•ì¸
            if (!currentGameState.word) {
                console.error('currentGameState.wordê°€ undefinedì…ë‹ˆë‹¤:', currentGameState);
                return;
            }

            document.getElementById('wordDisplay').textContent = currentGameState.word_display || '';
            document.getElementById('attemptsDisplay').textContent = `ë‚¨ì€ ê¸°íšŒ: ${currentGameState.attempts_left || 6}ë²ˆ`;
            
            const guessedStr = (currentGameState.guessed_letters && currentGameState.guessed_letters.length > 0) 
                ? currentGameState.guessed_letters.join(', ') 
                : 'ì—†ìŒ';
            document.getElementById('guessedLetters').textContent = `ì‹œë„í•œ ì•ŒíŒŒë²³: ${guessedStr}`;
            
            document.getElementById('progressDisplay').textContent = 
                `${currentGameState.current_question_num || 1} / ${currentGameState.total_questions || 8} ë¬¸ì œ`;
            
            // í˜„ì¬ ë¶„ì•¼ í‘œì‹œ
            const categoryNames = {
                'fruit': 'ê³¼ì¼',
                'weather': 'ë‚ ì”¨',
                'food': 'ìŒì‹',
                'country': 'ë‚˜ë¼',
                'number': 'ìˆ«ì',
                'school': 'í•™ìš©í’ˆ'
            };
            const currentCategory = selectedCategory || 'fruit';
            const categoryDisplayName = categoryNames[currentCategory] || 'ê³¼ì¼';
            document.getElementById('categoryDisplay').textContent = `ì£¼ì œ: ${categoryDisplayName}`;
            
            document.getElementById('totalScoreDisplay').textContent = `ëˆ„ì  ì ìˆ˜: ${currentGameState.score || 0}ì `;

            // ì„œë²„ì—ì„œ íŒíŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            console.log('updateDisplay - í˜„ì¬ íŒíŠ¸ ì¹´ìš´íŠ¸:', currentGameState.hint_count);
            // íŒíŠ¸ ì¹´ìš´íŠ¸ê°€ ì„œë²„ì—ì„œ ì œê³µë˜ë©´ í•­ìƒ ì—…ë°ì´íŠ¸
            if (currentGameState.hint_count !== undefined) {
                hintCount = currentGameState.hint_count;
                console.log('updateDisplay - íŒíŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ë¨:', hintCount);
            } else {
                console.log('updateDisplay - ì„œë²„ì—ì„œ íŒíŠ¸ ì¹´ìš´íŠ¸ê°€ ì œê³µë˜ì§€ ì•ŠìŒ');
            }
            updateHintButton();

            const bridgeImage = document.getElementById('bridgeImage');
            const bridgeStage = currentGameState.bridge_stage || 1;
            if (bridgeStage >= 1 && bridgeStage <= 5) {
                // ë‹¤ë¦¬1, ë‹¤ë¦¬5ëŠ” jpg, ë‹¤ë¦¬2,3,4ëŠ” gif
                let extension = 'jpg';
                if (bridgeStage >= 2 && bridgeStage <= 4) {
                    extension = 'gif';
                }
                bridgeImage.src = `/static/images/ë‹¤ë¦¬${bridgeStage}.${extension}`;
            }

            const characterOverlay = document.getElementById('characterOverlay');
            const characterPos = currentGameState.character_pos || 1;
            const bridgeWidth = bridgeImage.offsetWidth;
            const characterWidth = 100;
            
            const maxPosition = bridgeWidth - characterWidth;
            // currentGameState.wordê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            const wordLength = currentGameState.word ? currentGameState.word.length : 5;
            const positionRatio = (characterPos - 1) / wordLength;
            const leftPosition = Math.max(0, Math.min(maxPosition, positionRatio * maxPosition));
            
            characterOverlay.style.left = leftPosition + 'px';

            const treasureScore = document.getElementById('treasureScore');
            if (currentGameState.treasure_acquired) {
                treasureScore.style.display = 'block';
                setTimeout(() => {
                    treasureScore.style.display = 'none';
                }, 3000);
            } else {
                treasureScore.style.display = 'none';
            }
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            messageArea.innerHTML = '';
            messageArea.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // ê²Œì„ ì˜¤ë²„ ëª¨ë‹¬ í‘œì‹œ
        function showGameOverModal() {
            const modal = document.getElementById('gameOverModal');
            modal.style.display = 'block';
        }

        // ê²Œì„ ì˜¤ë²„ ëª¨ë‹¬ ë‹«ê¸°
        function closeGameOverModal() {
            const modal = document.getElementById('gameOverModal');
            modal.style.display = 'none';
            
            // ê²Œì„ ì˜ì—­ ìˆ¨ê¸°ê¸°
            document.getElementById('gameArea').style.display = 'none';
            
            // ì—­í•  ì„ íƒ ì°½ ë‹¤ì‹œ í‘œì‹œ
            document.querySelector('.role-selection').style.display = 'block';
            
            // êµì‚¬/í•™ìƒ íŒ¨ë„ ìˆ¨ê¸°ê¸°
            document.getElementById('teacherPanel').style.display = 'none';
            document.getElementById('studentPanel').style.display = 'none';
            
            // ë³€ìˆ˜ ì´ˆê¸°í™”
            currentGameState = null;
            selectedRole = null;
            selectedCategory = null;
            roomCode = null;
            customWords = [];
            
            showMessage('ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”.', 'warning');
        }

        // ìƒˆ ê²Œì„ ì‹œì‘ ë° ëª¨ë‹¬ ë‹«ê¸°
        function startNewGameAndCloseModal() {
            document.getElementById('gameOverModal').style.display = 'none';
            fetch('/start_game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    game_id: gameId,
                    category: selectedCategory,
                    room_code: roomCode,
                    reset_score: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentGameState = data.game_state;
                    updateDisplay();
                    showMessage('ìƒˆë¡œìš´ ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('ê²Œì„ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });
        }

        // ê²Œì„ ì¢…ë£Œ
        function endGame() {
            if (!currentGameState) {
                showMessage('ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }
            
            const modal = document.getElementById('gameEndModal');
            const title = document.getElementById('gameEndTitle');
            const yesButton = document.getElementById('yesButton');
            const noButton = document.getElementById('noButton');
            
            title.textContent = 'ê²Œì„ ì¢…ë£Œ';
            yesButton.textContent = 'ì˜ˆ';
            noButton.textContent = 'ì•„ë‹ˆìš”';
            
            document.getElementById('gameEndMessage').textContent = 
                `ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì ìˆ˜ëŠ” ${currentGameState.score}ì ì…ë‹ˆë‹¤. ìƒˆë¡œìš´ ê²Œì„ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            modal.style.display = 'block';
        }

        // ê²Œì„ ì¢…ë£Œ ëª¨ë‹¬ì—ì„œ ìƒˆ ê²Œì„ ì‹œì‘ (ì¹´í…Œê³ ë¦¬ ì„ íƒì°½ìœ¼ë¡œ)
        function startNewGameFromEndModal() {
            document.getElementById('gameEndModal').style.display = 'none';
            
            // ê²Œì„ ì˜ì—­ ìˆ¨ê¸°ê¸°
            document.getElementById('gameArea').style.display = 'none';
            
            // í•™ìƒ íŒ¨ë„ ë‹¤ì‹œ í‘œì‹œ (ì¹´í…Œê³ ë¦¬ ì„ íƒ)
            document.getElementById('studentPanel').style.display = 'block';
            
            // ë³€ìˆ˜ ì´ˆê¸°í™” (ë‹¨ì–´ ìƒíƒœë§Œ)
            currentGameState = null;
            
            showMessage('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì—¬ ìƒˆë¡œìš´ ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”.', 'success');
        }

        // ê²Œì„ ì¢…ë£Œ ëª¨ë‹¬ ë‹«ê¸° (ì—­í•  ì„ íƒì°½ìœ¼ë¡œ)
        function closeGameEndModal() {
            document.getElementById('gameEndModal').style.display = 'none';
            
            // ê²Œì„ ì˜ì—­ ìˆ¨ê¸°ê¸°
            document.getElementById('gameArea').style.display = 'none';
            
            // ì—­í•  ì„ íƒ ì°½ ë‹¤ì‹œ í‘œì‹œ
            document.querySelector('.role-selection').style.display = 'block';
            
            // êµì‚¬/í•™ìƒ íŒ¨ë„ ìˆ¨ê¸°ê¸°
            document.getElementById('teacherPanel').style.display = 'none';
            document.getElementById('studentPanel').style.display = 'none';
            
            // ë³€ìˆ˜ ì´ˆê¸°í™”
            currentGameState = null;
            selectedRole = null;
            selectedCategory = null;
            roomCode = null;
            customWords = [];
            
            showMessage('ìƒˆë¡œìš´ ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”.', 'warning');
        }

        // ê²Œì„ ì¢…ë£Œ ëª¨ë‹¬ ë‹«ê¸° (í˜„ì¬ ê²Œì„ ê³„ì†)
        function closeGameEndModalAndContinue() {
            document.getElementById('gameEndModal').style.display = 'none';
            // í˜„ì¬ ê²Œì„ í™”ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€
        }

        // ëª¨ë“  ë¬¸ì œ ì™„ë£Œ ì‹œ ìµœì¢… ì ìˆ˜ ì°½ í‘œì‹œ
        function showCompletionModal(message, finalScore) {
            const modal = document.getElementById('gameEndModal');
            const title = document.getElementById('gameEndTitle');
            const yesButton = document.getElementById('yesButton');
            const noButton = document.getElementById('noButton');
            
            title.textContent = 'ğŸ‰ ëª¨ë“  ë¬¸ì œ ì™„ë£Œ!';
            yesButton.textContent = 'ìƒˆë¡œìš´ ê²Œì„';
            noButton.textContent = 'ê²Œì„ ì¢…ë£Œ';
            
            modal.style.display = 'block';
            document.getElementById('gameEndMessage').textContent = message;
            
            currentGameState = null;
            updateDisplay();
        }

        // Enter í‚¤ ì´ë²¤íŠ¸
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processInput();
            }
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('quizModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        document.getElementById('gameOverModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        document.getElementById('gameEndModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // ìºë¦­í„°ë¥¼ ë³´ë¬¼ ìœ„ì¹˜ë¡œ ì¦‰ì‹œ ì´ë™
        function moveCharacterToTreasure() {
            if (!currentGameState) return;
            
            const characterOverlay = document.getElementById('characterOverlay');
            const bridgeImage = document.getElementById('bridgeImage');
            
            if (!characterOverlay || !bridgeImage) return;
            
            // ìºë¦­í„°ë¥¼ ë³´ë¬¼ ìœ„ì¹˜ë¡œ ì¦‰ì‹œ ì´ë™
            const bridgeWidth = bridgeImage.offsetWidth;
            const characterWidth = 100;
            const maxPosition = bridgeWidth - characterWidth;
            
            // ë³´ë¬¼ ìœ„ì¹˜ë¡œ ì´ë™ (ë‹¨ì–´ ê¸¸ì´ë§Œí¼ ì´ë™)
            const leftPosition = Math.max(0, Math.min(maxPosition, maxPosition));
            
            characterOverlay.style.left = leftPosition + 'px';
        }

        // +1ì  í‘œì‹œ
        function showScorePoint() {
            const treasureScore = document.getElementById('treasureScore');
            if (treasureScore) {
                treasureScore.style.display = 'block';
                treasureScore.textContent = '+1ì ';
                
                // 3ì´ˆ í›„ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    treasureScore.style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html> 