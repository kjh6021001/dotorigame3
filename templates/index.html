<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∞ ÎèÑÌÜ†Î¶¨ Î™®ÏúºÍ∏∞ üå∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2C3E50 0%, #34495E 100%);
            color: #ECF0F1;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            padding: 20px;
        }

        .game-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .role-selection {
            text-align: center;
            margin-bottom: 30px;
        }

        .role-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .role-btn {
            padding: 20px 40px;
            font-size: 1.3rem;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            min-width: 150px;
        }

        .role-btn.teacher {
            background: #E74C3C;
            color: white;
        }

        .role-btn.teacher:hover {
            background: #C0392B;
            transform: translateY(-3px);
        }

        .role-btn.student {
            background: #3498DB;
            color: white;
        }

        .role-btn.student:hover {
            background: #2980B9;
            transform: translateY(-3px);
        }

        .teacher-panel {
            display: none;
            background: rgba(52, 73, 94, 0.9);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .student-panel {
            display: none;
            background: rgba(52, 73, 94, 0.9);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .category-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .category-btn {
            padding: 15px;
            font-size: 1.1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            background: #27AE60;
            color: white;
        }

        .category-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .room-code-input {
            margin-top: 20px;
            text-align: center;
        }

        .room-code-input input {
            padding: 12px 20px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            background: rgba(236, 240, 241, 0.9);
            color: #2C3E50;
            width: 200px;
            margin-right: 10px;
        }

        .word-input-section {
            margin-top: 20px;
        }

        .word-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: center;
            align-items: center;
        }

        .word-input-group input {
            padding: 8px 15px;
            font-size: 1rem;
            border: none;
            border-radius: 5px;
            background: rgba(236, 240, 241, 0.9);
            color: #2C3E50;
            width: 150px;
        }

        .word-input-group input[placeholder*="Îúª"] {
            width: 200px;
        }

        .add-word-btn {
            padding: 8px 15px;
            font-size: 1rem;
            border: none;
            border-radius: 5px;
            background: #27AE60;
            color: white;
            cursor: pointer;
        }

        .add-word-btn:hover {
            background: #229954;
        }

        .word-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(44, 62, 80, 0.8);
            border-radius: 10px;
            padding: 15px;
        }

        .word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(52, 73, 94, 0.8);
            border-radius: 5px;
        }

        .remove-word-btn {
            padding: 5px 10px;
            font-size: 0.8rem;
            border: none;
            border-radius: 3px;
            background: #E74C3C;
            color: white;
            cursor: pointer;
        }

        .remove-word-btn:hover {
            background: #C0392B;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(44, 62, 80, 0.8);
            border-radius: 10px;
            border: 2px solid #3498DB;
        }

        .progress-info {
            font-size: 1.2rem;
            font-weight: bold;
            color: #F1C40F;
        }

        .score-info {
            font-size: 1.2rem;
            font-weight: bold;
            color: #27AE60;
        }

        .category-info {
            font-size: 1.2rem;
            font-weight: bold;
            color: #9B59B6;
        }

        .game-footer {
            text-align: center;
            margin-top: 20px;
        }

        .btn-danger {
            background: #E74C3C;
            color: white;
        }

        .btn-danger:hover {
            background: #C0392B;
            transform: translateY(-2px);
        }

        .game-card {
            background: rgba(52, 73, 94, 0.9);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-section {
            background: rgba(44, 62, 80, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #3498DB;
        }

        .word-display {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            letter-spacing: 5px;
            color: #F1C40F;
            margin-bottom: 10px;
        }

        .attempts {
            font-size: 1.2rem;
            color: #E74C3C;
            text-align: center;
        }

        .guessed-letters {
            font-size: 1rem;
            color: #BDC3C7;
            text-align: center;
        }

        .bridge-section {
            text-align: center;
            margin: 30px 0;
            position: relative;
        }

        .bridge-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .character-overlay {
            position: absolute;
            top: 25%;
            transform: translateY(-50%);
            width: 100px;
            height: 100px;
            transition: left 0.5s ease;
        }

        .character-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            mix-blend-mode: multiply;
            filter: contrast(1.1);
        }

        .treasure-overlay {
            position: absolute;
            top: 25%;
            right: 20px;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
        }

        .treasure-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .treasure-score {
            position: absolute;
            top: -30px;
            right: 0;
            background: #F1C40F;
            color: #2C3E50;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9rem;
            animation: bounce 0.5s ease-in-out;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .input-section {
            text-align: center;
            margin: 30px 0;
        }

        .input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .input-field {
            padding: 12px 20px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            background: rgba(236, 240, 241, 0.9);
            color: #2C3E50;
            width: 200px;
        }

        .btn {
            padding: 12px 25px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary {
            background: #27AE60;
            color: white;
        }

        .btn-primary:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #3498DB;
            color: white;
        }

        .btn-secondary:hover {
            background: #2980B9;
            transform: translateY(-2px);
        }

        .score-section {
            text-align: center;
            margin-top: 20px;
        }

        .score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #F1C40F;
        }

        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 30px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.3rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            z-index: 2000;
            min-width: 300px;
            backdrop-filter: blur(5px);
        }

        .message.success {
            background: rgba(39, 174, 96, 0.8);
            color: white;
        }

        .message.error {
            background: rgba(231, 76, 60, 0.8);
            color: white;
        }

        .message.warning {
            background: rgba(243, 156, 18, 0.8);
            color: white;
        }

        .quiz-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }

        .quiz-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2C3E50;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            min-width: 400px;
        }

        .quiz-options {
            display: grid;
            gap: 10px;
            margin-top: 20px;
        }

        .quiz-btn {
            padding: 15px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            background: #3498DB;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-btn:hover {
            background: #2980B9;
            transform: translateY(-2px);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: #ECF0F1;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #E74C3C;
        }

        .modal-body {
            text-align: center;
        }

        .modal-body p {
            font-size: 1.2rem;
            margin: 0;
        }

        .game-area {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .word-display {
                font-size: 1.5rem;
                letter-spacing: 3px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .input-field {
                width: 100%;
                max-width: 300px;
            }

            .role-buttons {
                flex-direction: column;
                align-items: center;
            }

            .category-selection {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="game-title">üå∞ ÎèÑÌÜ†Î¶¨ Î™®ÏúºÍ∏∞ üå∞</h1>
        
        <!-- Ïó≠Ìï† ÏÑ†ÌÉù -->
        <div class="role-selection">
            <h2>Ïñ¥ÎñªÍ≤å Ï∞∏Ïó¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?</h2>
            <div class="role-buttons">
                <button class="role-btn teacher" onclick="selectRole('teacher')">ÍµêÏÇ¨ (Î¨∏Ï†ú/Îã®Ïñ¥ ÏûÖÎ†•)</button>
                <button class="role-btn student" onclick="selectRole('student')">ÌïôÏÉù (Í≤åÏûÑ ÌîåÎ†àÏù¥)</button>
            </div>
        </div>

                          <!-- ÍµêÏÇ¨ Ìå®ÎÑê -->
          <div id="teacherPanel" class="teacher-panel">
              <h3 style="text-align: center; margin-bottom: 20px;">ÍµêÏÇ¨ Î™®Îìú - Ïª§Ïä§ÌÖÄ Îã®Ïñ¥ ÏûÖÎ†•</h3>
              <div class="word-input-section">
                  <div class="word-input-group">
                      <input type="text" id="wordInput" placeholder="ÏòÅÏñ¥ Îã®Ïñ¥" maxlength="20">
                      <input type="text" id="meaningInput" placeholder="ÌïúÍµ≠Ïñ¥ Îúª" maxlength="50">
                      <button class="add-word-btn" onclick="addWord()">Ï∂îÍ∞Ä</button>
                  </div>
              </div>
              <div class="word-list" id="wordList">
                  <p style="text-align: center; color: #BDC3C7;">Îã®Ïñ¥Î•º Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî</p>
              </div>
              <div id="messageArea"></div>
              <div style="text-align: center; margin-top: 20px;">
                  <button class="btn btn-primary" onclick="createRoom()">Î∞© ÏÉùÏÑ±ÌïòÍ∏∞</button>
              </div>
              <div style="text-align: center; margin-top: 15px;">
                  <button class="btn btn-secondary" onclick="backToRoleSelection()">Î™®Îìú ÏÑ†ÌÉùÌïòÍ∏∞</button>
              </div>
          </div>

                          <!-- ÌïôÏÉù Ìå®ÎÑê -->
          <div id="studentPanel" class="student-panel">
              <h3 style="text-align: center; margin-bottom: 20px;">ÌïôÏÉù Î™®Îìú - Í≤åÏûÑ ÏÑ†ÌÉù</h3>
              <div class="category-selection" id="categorySelection">
                  <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäºÎì§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                  <button class="category-btn" onclick="selectCategory('fruit')">Í≥ºÏùº</button>
                  <button class="category-btn" onclick="selectCategory('weather')">ÎÇ†Ïî®</button>
                  <button class="category-btn" onclick="selectCategory('food')">ÏùåÏãù</button>
                  <button class="category-btn" onclick="selectCategory('country')">ÎÇòÎùº</button>
                  <button class="category-btn" onclick="selectCategory('number')">Ïà´Ïûê</button>
                  <button class="category-btn" onclick="selectCategory('school')">ÌïôÏö©Ìíà</button>
              </div>
              <div class="room-code-input">
                  <h4 style="margin-bottom: 15px;">ÎòêÎäî Î∞©ÏΩîÎìúÎ°ú Ï∞∏Ïó¨</h4>
                  <input type="text" id="roomCodeInput" placeholder="Î∞©ÏΩîÎìú ÏûÖÎ†•" maxlength="6" style="text-transform: uppercase;">
                  <button class="btn btn-secondary" onclick="joinRoom()">Ï∞∏Ïó¨ÌïòÍ∏∞</button>
              </div>
              <div id="messageArea"></div>
              <div style="text-align: center; margin-top: 15px;">
                  <button class="btn btn-secondary" onclick="backToRoleSelection()">Î™®Îìú ÏÑ†ÌÉùÌïòÍ∏∞</button>
              </div>
          </div>

        <!-- Í≤åÏûÑ ÏòÅÏó≠ -->
        <div id="gameArea" class="game-area">
        <!-- ÏßÑÌñâ ÏÉÅÌô© Î∞è Ï†êÏàò ÌëúÏãú -->
        <div class="game-header">
            <div class="progress-info">
                <span id="progressDisplay">1 / 8 Î¨∏Ï†ú</span>
            </div>
                <div class="category-info">
                    <span id="categoryDisplay">Ï£ºÏ†ú: Í≥ºÏùº</span>
            </div>
            <div class="score-info">
                <span id="totalScoreDisplay">ÎàÑÏ†Å Ï†êÏàò: 0Ï†ê</span>
            </div>
        </div>
        
        <div class="game-card">
            <div class="game-info">
                <div class="info-section">
                    <div class="word-display" id="wordDisplay">_ _ _ _ _</div>
                    <div class="attempts" id="attemptsDisplay">ÎÇ®ÏùÄ Í∏∞Ìöå: 4Î≤à</div>
                </div>
                <div class="info-section">
                    <div class="guessed-letters" id="guessedLetters">ÏãúÎèÑÌïú ÏïåÌååÎ≤≥: ÏóÜÏùå</div>
                </div>
            </div>

            <div id="messageArea"></div>

            <div class="bridge-section">
                    <img id="bridgeImage" src="/static/images/Îã§Î¶¨1.jpg" alt="Îã§Î¶¨" class="bridge-image">
                
                <!-- Ï∫êÎ¶≠ÌÑ∞ Ïò§Î≤ÑÎ†àÏù¥ -->
                <div class="character-overlay" id="characterOverlay">
                    <img src="/static/images/ÏÇ¨Îûå.gif" alt="Ï∫êÎ¶≠ÌÑ∞" class="character-image">
                </div>
                
                <!-- Î≥¥Î¨º Ïò§Î≤ÑÎ†àÏù¥ -->
                <div class="treasure-overlay">
                    <span style="font-size: 2rem;">üå∞</span>
                    <div id="treasureScore" class="treasure-score" style="display: none;">+1Ï†ê</div>
                </div>
            </div>

            <div class="input-section">
                <div class="input-group">
                    <input type="text" id="userInput" class="input-field" placeholder="ÏïåÌååÎ≤≥ ÎòêÎäî Ï†ÑÏ≤¥ Îã®Ïñ¥ ÏûÖÎ†•" maxlength="20">
                    <button onclick="processInput()" class="btn btn-primary">ÏûÖÎ†•</button>
                         <button onclick="useHint()" class="btn btn-secondary" id="hintBtn">ÌûåÌä∏ (2/2)</button>
                </div>
            </div>
        </div>
        
        <!-- Í≤åÏûÑ Ï¢ÖÎ£å Î≤ÑÌäº -->
        <div class="game-footer">
            <button onclick="endGame()" class="btn btn-danger">Í≤åÏûÑ Ï¢ÖÎ£å</button>
            </div>
        </div>
    </div>

    <!-- ÌÄ¥Ï¶à Î™®Îã¨ -->
    <div id="quizModal" class="quiz-modal">
        <div class="quiz-content">
            <h2 id="quizQuestion">'apple'Ïùò ÎúªÏùÄ Î¨¥ÏóáÏùºÍπåÏöî?</h2>
            <div class="quiz-options" id="quizOptions">
                <!-- ÌÄ¥Ï¶à ÏòµÏÖòÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
        </div>
    </div>

    <!-- Í≤åÏûÑ Ïò§Î≤Ñ Î™®Îã¨ -->
    <div id="gameOverModal" class="quiz-modal">
        <div class="quiz-content">
            <h2>Îã§Î•∏ Îã®Ïñ¥Ïóê ÎèÑÏ†ÑÌïòÏãúÍ≤†ÏäµÎãàÍπå?</h2>
            <div class="quiz-options">
                <button class="quiz-btn" onclick="startNewGameAndCloseModal()">Ïòà</button>
                <button class="quiz-btn" onclick="closeGameOverModal()">ÏïÑÎãàÏöî</button>
            </div>
        </div>
    </div>

    <!-- Í≤åÏûÑ Ï¢ÖÎ£å Î™®Îã¨ -->
    <div id="gameEndModal" class="quiz-modal">
        <div class="quiz-content">
            <div class="modal-header">
                <h2 id="gameEndTitle">Í≤åÏûÑ Ï¢ÖÎ£å</h2>
                                 <button class="close-btn" onclick="closeGameEndModalAndContinue()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="gameEndMessage">Í≤åÏûÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.</p>
                <div class="quiz-options" style="margin-top: 20px;">
                    <button class="quiz-btn" id="yesButton" onclick="startNewGameFromEndModal()">Ïòà</button>
                    <button class="quiz-btn" id="noButton" onclick="closeGameEndModal()">ÏïÑÎãàÏöî</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let gameId = 'default';
        let currentGameState = null;
                 let selectedRole = null;
         let selectedCategory = null;
         let roomCode = null;
         let customWords = [];
         let hintCount = 2; // ÌûåÌä∏ ÏÇ¨Ïö© ÌöüÏàò (ÏÑúÎ≤ÑÏóêÏÑú Í¥ÄÎ¶¨Îê®)

                 // Ïó≠Ìï† ÏÑ†ÌÉù
         function selectRole(role) {
             selectedRole = role;
             document.querySelector('.role-selection').style.display = 'none';
             
             if (role === 'teacher') {
                 document.getElementById('teacherPanel').style.display = 'block';
             } else {
                 document.getElementById('studentPanel').style.display = 'block';
                 loadCategories();
             }
         }

         // Ïó≠Ìï† ÏÑ†ÌÉùÏ∞ΩÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
         function backToRoleSelection() {
             // ÌòÑÏû¨ Ìå®ÎÑêÎì§ Ïà®Í∏∞Í∏∞
             document.getElementById('teacherPanel').style.display = 'none';
             document.getElementById('studentPanel').style.display = 'none';
             
             // Ïó≠Ìï† ÏÑ†ÌÉùÏ∞Ω Îã§Ïãú ÌëúÏãú
             document.querySelector('.role-selection').style.display = 'block';
             
             // Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
             selectedRole = null;
             selectedCategory = null;
             roomCode = null;
             customWords = [];
         }

        // Ïπ¥ÌÖåÍ≥†Î¶¨ Î°úÎìú
        function loadCategories() {
            fetch('/get_categories')
                .then(response => response.json())
                .then(data => {
                    const categorySelection = document.getElementById('categorySelection');
                    categorySelection.innerHTML = '';
                    
                    // Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ Îß§Ìïë
                    const categoryNames = {
                        'fruit': 'Í≥ºÏùº',
                        'weather': 'ÎÇ†Ïî®',
                        'food': 'ÏùåÏãù',
                        'country': 'ÎÇòÎùº',
                        'number': 'Ïà´Ïûê',
                        'school': 'ÌïôÏö©Ìíà'
                    };
                    
                    console.log('Ïπ¥ÌÖåÍ≥†Î¶¨ Îç∞Ïù¥ÌÑ∞:', data);
                    
                    data.forEach(category => {
                        const button = document.createElement('button');
                        button.className = 'category-btn';
                        button.textContent = categoryNames[category] || category;
                        button.onclick = () => selectCategory(category);
                        categorySelection.appendChild(button);
                        console.log('Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäº Ï∂îÍ∞Ä:', category);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                    
                    // Ïò§Î•ò Î∞úÏÉù Ïãú Í∏∞Î≥∏ Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤ÑÌäºÎì§ Ï∂îÍ∞Ä
                    const categorySelection = document.getElementById('categorySelection');
                    const defaultCategories = ['fruit', 'weather', 'food', 'country', 'number', 'school'];
                    const categoryNames = {
                        'fruit': 'Í≥ºÏùº',
                        'weather': 'ÎÇ†Ïî®',
                        'food': 'ÏùåÏãù',
                        'country': 'ÎÇòÎùº',
                        'number': 'Ïà´Ïûê',
                        'school': 'ÌïôÏö©Ìíà'
                    };
                    
                    defaultCategories.forEach(category => {
                        const button = document.createElement('button');
                        button.className = 'category-btn';
                        button.textContent = categoryNames[category];
                        button.onclick = () => selectCategory(category);
                        categorySelection.appendChild(button);
                    });
                });
        }

        // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù
        function selectCategory(category) {
            selectedCategory = category;
            // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù Ïãú Î∞© ÏΩîÎìú Ï¥àÍ∏∞Ìôî (Îã§Î•∏ Í≤åÏûÑÏúºÎ°ú Ï†ÑÌôò)
            roomCode = null;
            document.getElementById('studentPanel').style.display = 'none';
            startGame();
        }

        // Î∞©ÏΩîÎìúÎ°ú Ï∞∏Ïó¨
        function joinRoom() {
            const roomCodeInput = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (!roomCodeInput) {
                showMessage('Î∞©ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }

            fetch('/join_room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ room_code: roomCodeInput })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    roomCode = roomCodeInput;
                    document.getElementById('studentPanel').style.display = 'none';
                    startGame();
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Î∞© Ï∞∏Ïó¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            });
        }

        // Îã®Ïñ¥ Ï∂îÍ∞Ä
        function addWord() {
            const wordInput = document.getElementById('wordInput');
            const meaningInput = document.getElementById('meaningInput');
            
            const word = wordInput.value.trim();
            const meaning = meaningInput.value.trim();
            
            if (!word || !meaning) {
                showMessage('Îã®Ïñ¥ÏôÄ ÎúªÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }
            
            customWords.push([word, meaning]);
            updateWordList();
            
            wordInput.value = '';
            meaningInput.value = '';
            wordInput.focus();
        }

        // Îã®Ïñ¥ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function updateWordList() {
            const wordList = document.getElementById('wordList');
            if (customWords.length === 0) {
                wordList.innerHTML = '<p style="text-align: center; color: #BDC3C7;">Îã®Ïñ¥Î•º Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî</p>';
                return;
            }
            
            wordList.innerHTML = '';
            customWords.forEach((wordPair, index) => {
                const wordItem = document.createElement('div');
                wordItem.className = 'word-item';
                wordItem.innerHTML = `
                    <span>${wordPair[0]} - ${wordPair[1]}</span>
                    <button class="remove-word-btn" onclick="removeWord(${index})">ÏÇ≠Ï†ú</button>
                `;
                wordList.appendChild(wordItem);
            });
        }

        // Îã®Ïñ¥ ÏÇ≠Ï†ú
        function removeWord(index) {
            customWords.splice(index, 1);
            updateWordList();
        }

        // Î∞© ÏÉùÏÑ±
        function createRoom() {
            console.log('Î∞© ÏÉùÏÑ± Ìï®Ïàò Ìò∏Ï∂úÎê®');  // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
            console.log('customWords:', customWords);  // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
            
            if (customWords.length === 0) {
                console.log('Îã®Ïñ¥Í∞Ä ÏóÜÏùå');  // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
                showMessage('ÏµúÏÜå ÌïòÎÇòÏùò Îã®Ïñ¥Î•º Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }
            
            console.log('ÏÑúÎ≤ÑÏóê ÏöîÏ≤≠ Ï†ÑÏÜ° Ï§ë...');  // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
            console.log('Ï†ÑÏÜ°Ìï† Îç∞Ïù¥ÌÑ∞:', JSON.stringify({ words: customWords }));  // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
            
            fetch('/create_room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ words: customWords })
            })
            .then(response => {
                console.log('ÏÑúÎ≤Ñ ÏùëÎãµ Î∞õÏùå:', response);  // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
                console.log('ÏùëÎãµ ÏÉÅÌÉú:', response.status);  // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
                console.log('ÏùëÎãµ Ìó§Îçî:', response.headers);  // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', data);  // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
                if (data.success) {
                    console.log('Î∞© ÏÉùÏÑ± ÏÑ±Í≥µ:', data.room_code);  // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
                    showMessage(data.message, 'success');
                    
                    // ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ ÏãúÎèÑ (ÏôÑÏ†ÑÌûà ÏïàÏ†ÑÌïòÍ≤å Ï≤òÎ¶¨)
                    const roomCode = data.room_code;
                    
                    // ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ Ìï®Ïàò
                    const copyToClipboard = async (text) => {
                        try {
                            // Î™®Îçò Î∏åÎùºÏö∞Ï†ÄÏö© ÌÅ¥Î¶ΩÎ≥¥Îìú API
                            if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                                await navigator.clipboard.writeText(text);
                                return true;
                            }
                            // Íµ¨Ìòï Î∏åÎùºÏö∞Ï†ÄÏö© fallback
                            else if (window.clipboardData && window.clipboardData.setData) {
                                window.clipboardData.setData('text', text);
                                return true;
                            }
                            // document.execCommand fallback (deprecated but still works)
                            else {
                                const textArea = document.createElement('textarea');
                                textArea.value = text;
                                textArea.style.position = 'fixed';
                                textArea.style.left = '-999999px';
                                textArea.style.top = '-999999px';
                                document.body.appendChild(textArea);
                                textArea.focus();
                                textArea.select();
                                const successful = document.execCommand('copy');
                                document.body.removeChild(textArea);
                                return successful;
                            }
                        } catch (err) {
                            console.log('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ Ïã§Ìå®:', err);
                            return false;
                        }
                    };
                    
                    // ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ ÏãúÎèÑ
                    copyToClipboard(roomCode).then(success => {
                        if (success) {
                            showMessage('Î∞©ÏΩîÎìúÍ∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.', 'success');
                        } else {
                            showMessage(`Î∞©ÏΩîÎìú: ${roomCode} (Î≥µÏÇ¨ÌïòÎ†§Î©¥ ÏàòÎèôÏúºÎ°ú ÏÑ†ÌÉùÌïòÏÑ∏Ïöî)`, 'success');
                        }
                    }).catch(err => {
                        console.log('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ Ï§ë Ïò§Î•ò:', err);
                        showMessage(`Î∞©ÏΩîÎìú: ${roomCode} (Î≥µÏÇ¨ÌïòÎ†§Î©¥ ÏàòÎèôÏúºÎ°ú ÏÑ†ÌÉùÌïòÏÑ∏Ïöî)`, 'success');
                    });
                } else {
                    console.log('Î∞© ÏÉùÏÑ± Ïã§Ìå®:', data.error);  // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Î∞© ÏÉùÏÑ± Ïò§Î•ò:', error);
                console.error('Ïò§Î•ò ÏÉÅÏÑ∏:', error.message);  // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
                showMessage(`Î∞© ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`, 'error');
            });
        }

                         // Í≤åÏûÑ ÏãúÏûë (ÏÉàÎ°úÏö¥ Í≤åÏûÑ - Ï†êÏàò Î¶¨ÏÖã)
        function startGame() {
            document.getElementById('gameArea').style.display = 'block';
            
            fetch('/start_game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                 body: JSON.stringify({ 
                     game_id: gameId,
                     category: selectedCategory,
                     room_code: roomCode,
                     reset_score: true  // ÏÉàÎ°úÏö¥ Í≤åÏûÑÏù¥ÎØÄÎ°ú Ï†êÏàò Î¶¨ÏÖã
                 })
            })
            .then(response => response.json())
            .then(data => {
                console.log('startGame ÏÑúÎ≤Ñ ÏùëÎãµ:', data);
                if (data.success) {
                    currentGameState = data.game_state;
                    console.log('startGame currentGameState:', currentGameState);
                    console.log('startGame word:', currentGameState.word);
                    console.log('startGame word_display:', currentGameState.word_display);
                    // ÌûåÌä∏ Ïπ¥Ïö¥Ìä∏ Ï¥àÍ∏∞Ìôî
                    hintCount = currentGameState.hint_count || 2;
                    console.log('startGame - ÌûåÌä∏ Ïπ¥Ïö¥Ìä∏ Ï¥àÍ∏∞Ìôî:', hintCount);
                    updateDisplay();
                    updateHintButton();
                } else {
                    console.error('startGame Ïã§Ìå®:', data);
                    showMessage('Í≤åÏûÑ ÏãúÏûëÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Í≤åÏûÑ ÏãúÏûë Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            });
        }

        // ÏÉàÎ°úÏö¥ Îã®Ïñ¥ ÏãúÏûë (ÌûåÌä∏ Ïπ¥Ïö¥Ìä∏ Î¶¨ÏÖã)
        function startNewWord() {
            fetch('/start_new_word', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    game_id: gameId,
                    category: selectedCategory,
                    room_code: roomCode
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentGameState = data.game_state;
                    console.log('ÏÉà Îã®Ïñ¥ ÏãúÏûë - ÏÑúÎ≤Ñ ÏùëÎãµ:', data);
                    console.log('ÏÉà Îã®Ïñ¥ ÏãúÏûë - ÌûåÌä∏ Ïπ¥Ïö¥Ìä∏:', currentGameState.hint_count);
                    // ÌûåÌä∏ Ïπ¥Ïö¥Ìä∏ Î™ÖÏãúÏ†Å Î¶¨ÏÖã
                    hintCount = currentGameState.hint_count || 2;
                    console.log('ÏÉà Îã®Ïñ¥ ÏãúÏûë - Î°úÏª¨ ÌûåÌä∏ Ïπ¥Ïö¥Ìä∏ Î¶¨ÏÖã:', hintCount);
                    updateDisplay();
                    showMessage('ÏÉàÎ°úÏö¥ Îã®Ïñ¥Í∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!', 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('ÏÉà Îã®Ïñ¥ ÏãúÏûë Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            });
        }

                         // ÌûåÌä∏ ÏÇ¨Ïö©
        function useHint() {
            if (!currentGameState) {
                showMessage('Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            if (!currentGameState.word) {
                console.error('currentGameState.wordÍ∞Ä undefinedÏûÖÎãàÎã§:', currentGameState);
                showMessage('Í≤åÏûÑ ÏÉÅÌÉúÏóê Î¨∏Ï†úÍ∞Ä ÏûàÏäµÎãàÎã§.', 'error');
                return;
            }
            
            if (hintCount <= 0) {
                showMessage('Ïù¥ Îã®Ïñ¥Ïóê ÎåÄÌïú ÌûåÌä∏Î•º Î™®Îëê ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§.', 'warning');
                return;
            }
             
             // ÌòÑÏû¨ Îã®Ïñ¥ÏóêÏÑú Í∞ÄÏû• ÎßéÏù¥ ÎÇòÏò§Îäî Ï≤†Ïûê Ï∞æÍ∏∞
             const word = currentGameState.word.toLowerCase();
             const letterCount = {};
             
             // Í∞Å Ï≤†ÏûêÏùò ÎπàÎèÑÏàò Í≥ÑÏÇ∞
             for (let letter of word) {
                 letterCount[letter] = (letterCount[letter] || 0) + 1;
             }
             
                           // Í∞ÄÏû• ÎßéÏù¥ ÎÇòÏò§Îäî Ï≤†Ïûê Ï∞æÍ∏∞ (Ïù¥ÎØ∏ Ï∂îÏ∏°Ìïú Ï≤†ÏûêÎäî Ï†úÏô∏)
              let maxLetter = '';
              let maxCount = 0;
              
              for (let letter in letterCount) {
                  // Ïù¥ÎØ∏ Ï∂îÏ∏°Ìïú Ï≤†ÏûêÏù∏ÏßÄ ÌôïÏù∏
                  const isAlreadyGuessed = currentGameState.guessed_letters && currentGameState.guessed_letters.some(guessed => 
                      guessed.toLowerCase() === letter.toLowerCase()
                  );
                  
                  if (letterCount[letter] > maxCount && !isAlreadyGuessed) {
                      maxLetter = letter;
                      maxCount = letterCount[letter];
                  }
              }
             
             if (!maxLetter) {
                 showMessage('Îçî Ïù¥ÏÉÅ Í≥µÍ∞úÌï† ÌûåÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.', 'warning');
                 return;
             }
             
             // ÌûåÌä∏ ÏÇ¨Ïö© ÏöîÏ≤≠
             fetch('/use_hint', {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json',
                 },
                 body: JSON.stringify({ 
                     game_id: gameId
                 })
             })
             .then(response => response.json())
             .then(data => {
                console.log('useHint ÏÑúÎ≤Ñ ÏùëÎãµ:', data);
                if (data.success) {
                    currentGameState = data.game_state;
                    hintCount = data.hint_count; // ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ ÌûåÌä∏ Ïπ¥Ïö¥Ìä∏ ÏÇ¨Ïö©
                    console.log('useHint - ÌûåÌä∏ Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏:', hintCount);
                    updateDisplay();
                    updateHintButton();
                    // ÏÑúÎ≤ÑÏóêÏÑú Ï†úÍ≥µÌïú ÌûåÌä∏ Ï†ïÎ≥¥ ÏÇ¨Ïö©
                    const hintLetter = data.hint;
                    const hintCountInWord = (currentGameState.word.match(new RegExp(hintLetter, 'gi')) || []).length;
                    showMessage(`ÌûåÌä∏: '${hintLetter.toUpperCase()}'Í∞Ä ${hintCountInWord}Î≤à ÎÇòÏòµÎãàÎã§!`, 'success');
                } else {
                    showMessage(data.error, 'error');
                }
            })
             .catch(error => {
                 console.error('Error:', error);
                 showMessage('ÌûåÌä∏ ÏÇ¨Ïö© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
             });
         }
         
         // ÌûåÌä∏ Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏
         function updateHintButton() {
             const hintBtn = document.getElementById('hintBtn');
             console.log('updateHintButton - ÌûåÌä∏ Ïπ¥Ïö¥Ìä∏:', hintCount);
             hintBtn.textContent = `ÌûåÌä∏ (${hintCount}/2)`;
             
             if (hintCount <= 0) {
                 hintBtn.disabled = true;
                 hintBtn.style.opacity = '0.5';
                 hintBtn.style.cursor = 'not-allowed';
                 console.log('updateHintButton - ÌûåÌä∏ Î≤ÑÌäº ÎπÑÌôúÏÑ±ÌôîÎê®');
             } else {
                 hintBtn.disabled = false;
                 hintBtn.style.opacity = '1';
                 hintBtn.style.cursor = 'pointer';
                 console.log('updateHintButton - ÌûåÌä∏ Î≤ÑÌäº ÌôúÏÑ±ÌôîÎê®');
             }
        }

        // ÏÇ¨Ïö©Ïûê ÏûÖÎ†• Ï≤òÎ¶¨
        function processInput() {
            const input = document.getElementById('userInput').value.trim();
            if (!input) {
                showMessage('ÏûÖÎ†•ÏùÑ Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }

            fetch('/process_input', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    game_id: gameId,
                    input: input 
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('processInput ÏÑúÎ≤Ñ ÏùëÎãµ:', data);
                if (data.error) {
                    showMessage(data.error, 'error');
                } else if (data.success) {
                    currentGameState = data.game_state;
                    console.log('processInput currentGameState:', currentGameState);
                    updateDisplay();
                    showMessage(data.message, 'success');

                    if (data.word_complete) {
                        // Ï†ïÎãµÏùÑ ÎßûÏ∑ÑÏùÑ Îïå Ï¶âÏãú Ï∫êÎ¶≠ÌÑ∞Î•º Î≥¥Î¨º ÏúÑÏπòÎ°ú Ïù¥Îèô
                        moveCharacterToTreasure();
                        // +1Ï†ê ÌëúÏãú
                        showScorePoint();
                        // Ï†ïÎãµ Î©îÏãúÏßÄ ÌëúÏãú
                        showMessage('Ï†ïÎãµÏùÑ ÎßûÏ∂îÏÖ®ÏäµÎãàÎã§.', 'success');
                        // 1Ï¥à ÌõÑ ÌÄ¥Ï¶à ÌëúÏãú
                        setTimeout(() => showQuiz(), 1000);
                    } else if (data.game_over) {
                        setTimeout(() => {
                            showGameOverModal();
                        }, 2000);
                    }
                } else {
                    console.error('processInput Ïã§Ìå®:', data);
                    showMessage('ÏûÖÎ†• Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('ÏûÖÎ†• Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            });

            document.getElementById('userInput').value = '';
        }

        // ÌÄ¥Ï¶à ÌëúÏãú
        function showQuiz() {
            const modal = document.getElementById('quizModal');
            const question = document.getElementById('quizQuestion');
            const options = document.getElementById('quizOptions');

            question.textContent = `'${currentGameState.word}'Ïùò ÎúªÏùÄ Î¨¥ÏóáÏùºÍπåÏöî?`;

            const correctAnswer = currentGameState.meaning;
            
            if (!correctAnswer) {
                console.error('Meaning is missing from game state!');
                showMessage('ÌÄ¥Ï¶à Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                return;
            }
            
            // ÌòÑÏû¨ Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò ÎúªÎì§ÏùÑ Í∞ÄÏ†∏ÏôÄÏÑú ÏòµÏÖò ÏÉùÏÑ±
            // Í≤åÏûÑ ÏÉÅÌÉúÏóêÏÑú Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            let category = currentGameState.category || selectedCategory || 'fruit';
            fetch(`/get_category_meanings?category=${category}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const categoryMeanings = data.meanings;
                        const wrongOptions = categoryMeanings.filter(meaning => meaning !== correctAnswer);
                        const selectedWrongOptions = [];
                        
                        const shuffledWrongOptions = [...wrongOptions].sort(() => Math.random() - 0.5);
                        
                        for (let i = 0; i < Math.min(2, shuffledWrongOptions.length); i++) {
                            selectedWrongOptions.push(shuffledWrongOptions[i]);
                        }
                        
                        const allOptions = [correctAnswer, ...selectedWrongOptions];
                        
                        for (let i = allOptions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [allOptions[i], allOptions[j]] = [allOptions[j], allOptions[i]];
                        }

                        options.innerHTML = '';
                        allOptions.forEach(option => {
                            const button = document.createElement('button');
                            button.className = 'quiz-btn';
                            button.textContent = option;
                            button.onclick = () => checkQuizAnswer(option);
                            options.appendChild(button);
                        });

                        modal.style.display = 'block';
                    } else {
                        // Ïã§Ìå® Ïãú Í∏∞Î≥∏ Í≥ºÏùº ÎúªÎì§ ÏÇ¨Ïö©
                        const defaultOptions = ['ÏÇ¨Í≥º', 'Î∞îÎÇòÎÇò', 'Ïò§Î†åÏßÄ', 'Ìè¨ÎèÑ', 'Îî∏Í∏∞', 'ÏàòÎ∞ï', 'Î≥µÏà≠ÏïÑ', 'Î†àÎ™¨', 'Ï≤¥Î¶¨'];
                        const wrongOptions = defaultOptions.filter(option => option !== correctAnswer);
            const selectedWrongOptions = [];
                        
            const shuffledWrongOptions = [...wrongOptions].sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < Math.min(2, shuffledWrongOptions.length); i++) {
                selectedWrongOptions.push(shuffledWrongOptions[i]);
            }
            
            const allOptions = [correctAnswer, ...selectedWrongOptions];
            
            for (let i = allOptions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allOptions[i], allOptions[j]] = [allOptions[j], allOptions[i]];
            }
            
                        options.innerHTML = '';
                        allOptions.forEach(option => {
                            const button = document.createElement('button');
                            button.className = 'quiz-btn';
                            button.textContent = option;
                            button.onclick = () => checkQuizAnswer(option);
                            options.appendChild(button);
                        });

                        modal.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // ÏóêÎü¨ Ïãú Í∏∞Î≥∏ Í≥ºÏùº ÎúªÎì§ ÏÇ¨Ïö©
                    const defaultOptions = ['ÏÇ¨Í≥º', 'Î∞îÎÇòÎÇò', 'Ïò§Î†åÏßÄ', 'Ìè¨ÎèÑ', 'Îî∏Í∏∞', 'ÏàòÎ∞ï', 'Î≥µÏà≠ÏïÑ', 'Î†àÎ™¨', 'Ï≤¥Î¶¨'];
                    const wrongOptions = defaultOptions.filter(option => option !== correctAnswer);
                    const selectedWrongOptions = [];
                    
                    const shuffledWrongOptions = [...wrongOptions].sort(() => Math.random() - 0.5);
                    
                    for (let i = 0; i < Math.min(2, shuffledWrongOptions.length); i++) {
                        selectedWrongOptions.push(shuffledWrongOptions[i]);
                    }
                    
                    const allOptions = [correctAnswer, ...selectedWrongOptions];
                    
                    for (let i = allOptions.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [allOptions[i], allOptions[j]] = [allOptions[j], allOptions[i]];
                    }

            options.innerHTML = '';
            allOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'quiz-btn';
                button.textContent = option;
                button.onclick = () => checkQuizAnswer(option);
                options.appendChild(button);
            });

            modal.style.display = 'block';
                });
        }

        // ÌÄ¥Ï¶à ÎãµÏïà ÌôïÏù∏
        function checkQuizAnswer(answer) {
            fetch('/check_quiz', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    game_id: gameId,
                    answer: answer 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('quizModal').style.display = 'none';
                    showMessage(data.message, data.correct ? 'success' : 'error');
                    
                    currentGameState.score = data.score;
                    updateDisplay();
                    
                    if (data.game_complete) {
                        setTimeout(() => {
                            showCompletionModal(data.completion_message, data.final_score);
                        }, 2000);
                    } else if (data.next_question) {
                        setTimeout(() => {
                            showMessage('Îã§Ïùå Î¨∏Ï†úÎ°ú ÏßÑÌñâÌï©ÎãàÎã§...', 'warning');
                            setTimeout(startNewWord, 2000);
                        }, 2000);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('ÌÄ¥Ï¶à Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            });
        }

        // ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateDisplay() {
            console.log('updateDisplay Ìò∏Ï∂úÎê® - currentGameState:', currentGameState);
            if (!currentGameState) {
                console.error('currentGameStateÍ∞Ä undefinedÏûÖÎãàÎã§.');
                return;
            }

            // ÌïÑÏàò ÏÜçÏÑ±Îì§Ïù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
            if (!currentGameState.word) {
                console.error('currentGameState.wordÍ∞Ä undefinedÏûÖÎãàÎã§:', currentGameState);
                return;
            }

            document.getElementById('wordDisplay').textContent = currentGameState.word_display || '';
            document.getElementById('attemptsDisplay').textContent = `ÎÇ®ÏùÄ Í∏∞Ìöå: ${currentGameState.attempts_left || 6}Î≤à`;
            
            const guessedStr = (currentGameState.guessed_letters && currentGameState.guessed_letters.length > 0) 
                ? currentGameState.guessed_letters.join(', ') 
                : 'ÏóÜÏùå';
            document.getElementById('guessedLetters').textContent = `ÏãúÎèÑÌïú ÏïåÌååÎ≤≥: ${guessedStr}`;
            
            document.getElementById('progressDisplay').textContent = 
                `${currentGameState.current_question_num || 1} / ${currentGameState.total_questions || 8} Î¨∏Ï†ú`;
            
            // ÌòÑÏû¨ Î∂ÑÏïº ÌëúÏãú
            const categoryNames = {
                'fruit': 'Í≥ºÏùº',
                'weather': 'ÎÇ†Ïî®',
                'food': 'ÏùåÏãù',
                'country': 'ÎÇòÎùº',
                'number': 'Ïà´Ïûê',
                'school': 'ÌïôÏö©Ìíà'
            };
            const currentCategory = selectedCategory || 'fruit';
            const categoryDisplayName = categoryNames[currentCategory] || 'Í≥ºÏùº';
            document.getElementById('categoryDisplay').textContent = `Ï£ºÏ†ú: ${categoryDisplayName}`;
            
            document.getElementById('totalScoreDisplay').textContent = `ÎàÑÏ†Å Ï†êÏàò: ${currentGameState.score || 0}Ï†ê`;

            // ÏÑúÎ≤ÑÏóêÏÑú ÌûåÌä∏ Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            console.log('updateDisplay - ÌòÑÏû¨ ÌûåÌä∏ Ïπ¥Ïö¥Ìä∏:', currentGameState.hint_count);
            // ÌûåÌä∏ Ïπ¥Ïö¥Ìä∏Í∞Ä ÏÑúÎ≤ÑÏóêÏÑú Ï†úÍ≥µÎêòÎ©¥ Ìï≠ÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏
            if (currentGameState.hint_count !== undefined) {
                hintCount = currentGameState.hint_count;
                console.log('updateDisplay - ÌûåÌä∏ Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏Îê®:', hintCount);
            } else {
                console.log('updateDisplay - ÏÑúÎ≤ÑÏóêÏÑú ÌûåÌä∏ Ïπ¥Ïö¥Ìä∏Í∞Ä Ï†úÍ≥µÎêòÏßÄ ÏïäÏùå');
            }
            updateHintButton();

            const bridgeImage = document.getElementById('bridgeImage');
            const bridgeStage = currentGameState.bridge_stage || 1;
            if (bridgeStage >= 1 && bridgeStage <= 5) {
                // Îã§Î¶¨1, Îã§Î¶¨5Îäî jpg, Îã§Î¶¨2,3,4Îäî gif
                let extension = 'jpg';
                if (bridgeStage >= 2 && bridgeStage <= 4) {
                    extension = 'gif';
                }
                bridgeImage.src = `/static/images/Îã§Î¶¨${bridgeStage}.${extension}`;
            }

            const characterOverlay = document.getElementById('characterOverlay');
            const characterPos = currentGameState.character_pos || 1;
            const bridgeWidth = bridgeImage.offsetWidth;
            const characterWidth = 100;
            
            const maxPosition = bridgeWidth - characterWidth;
            // currentGameState.wordÍ∞Ä Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏
            const wordLength = currentGameState.word ? currentGameState.word.length : 5;
            const positionRatio = (characterPos - 1) / wordLength;
            const leftPosition = Math.max(0, Math.min(maxPosition, positionRatio * maxPosition));
            
            characterOverlay.style.left = leftPosition + 'px';

            const treasureScore = document.getElementById('treasureScore');
            if (currentGameState.treasure_acquired) {
                treasureScore.style.display = 'block';
                setTimeout(() => {
                    treasureScore.style.display = 'none';
                }, 3000);
            } else {
                treasureScore.style.display = 'none';
            }
        }

        // Î©îÏãúÏßÄ ÌëúÏãú
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            messageArea.innerHTML = '';
            messageArea.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Í≤åÏûÑ Ïò§Î≤Ñ Î™®Îã¨ ÌëúÏãú
        function showGameOverModal() {
            const modal = document.getElementById('gameOverModal');
            modal.style.display = 'block';
        }

        // Í≤åÏûÑ Ïò§Î≤Ñ Î™®Îã¨ Îã´Í∏∞
        function closeGameOverModal() {
            const modal = document.getElementById('gameOverModal');
            modal.style.display = 'none';
            
            // Í≤åÏûÑ ÏòÅÏó≠ Ïà®Í∏∞Í∏∞
            document.getElementById('gameArea').style.display = 'none';
            
            // Ïó≠Ìï† ÏÑ†ÌÉù Ï∞Ω Îã§Ïãú ÌëúÏãú
            document.querySelector('.role-selection').style.display = 'block';
            
            // ÍµêÏÇ¨/ÌïôÏÉù Ìå®ÎÑê Ïà®Í∏∞Í∏∞
            document.getElementById('teacherPanel').style.display = 'none';
            document.getElementById('studentPanel').style.display = 'none';
            
            // Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
            currentGameState = null;
            selectedRole = null;
            selectedCategory = null;
            roomCode = null;
            customWords = [];
            
            showMessage('Í≤åÏûÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§. ÏÉàÎ°úÏö¥ Í≤åÏûÑÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî.', 'warning');
        }

        // ÏÉà Í≤åÏûÑ ÏãúÏûë Î∞è Î™®Îã¨ Îã´Í∏∞
        function startNewGameAndCloseModal() {
            document.getElementById('gameOverModal').style.display = 'none';
            fetch('/start_game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    game_id: gameId,
                    category: selectedCategory,
                    room_code: roomCode,
                    reset_score: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentGameState = data.game_state;
                    updateDisplay();
                    showMessage('ÏÉàÎ°úÏö¥ Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!', 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Í≤åÏûÑ ÏãúÏûë Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            });
        }

        // Í≤åÏûÑ Ï¢ÖÎ£å
        function endGame() {
            if (!currentGameState) {
                showMessage('Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'warning');
                return;
            }
            
            const modal = document.getElementById('gameEndModal');
            const title = document.getElementById('gameEndTitle');
            const yesButton = document.getElementById('yesButton');
            const noButton = document.getElementById('noButton');
            
            title.textContent = 'Í≤åÏûÑ Ï¢ÖÎ£å';
            yesButton.textContent = 'Ïòà';
            noButton.textContent = 'ÏïÑÎãàÏöî';
            
            document.getElementById('gameEndMessage').textContent = 
                `Í≤åÏûÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§. Ï†êÏàòÎäî ${currentGameState.score}Ï†êÏûÖÎãàÎã§. ÏÉàÎ°úÏö¥ Í≤åÏûÑÏùÑ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;
            modal.style.display = 'block';
        }

        // Í≤åÏûÑ Ï¢ÖÎ£å Î™®Îã¨ÏóêÏÑú ÏÉà Í≤åÏûÑ ÏãúÏûë (Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉùÏ∞ΩÏúºÎ°ú)
        function startNewGameFromEndModal() {
            document.getElementById('gameEndModal').style.display = 'none';
            
            // Í≤åÏûÑ ÏòÅÏó≠ Ïà®Í∏∞Í∏∞
            document.getElementById('gameArea').style.display = 'none';
            
            // ÌïôÏÉù Ìå®ÎÑê Îã§Ïãú ÌëúÏãú (Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù)
            document.getElementById('studentPanel').style.display = 'block';
            
            // Î≥ÄÏàò Ï¥àÍ∏∞Ìôî (Îã®Ïñ¥ ÏÉÅÌÉúÎßå)
            currentGameState = null;
            
            showMessage('Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏó¨ ÏÉàÎ°úÏö¥ Í≤åÏûÑÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî.', 'success');
        }

        // Í≤åÏûÑ Ï¢ÖÎ£å Î™®Îã¨ Îã´Í∏∞ (Ïó≠Ìï† ÏÑ†ÌÉùÏ∞ΩÏúºÎ°ú)
        function closeGameEndModal() {
            document.getElementById('gameEndModal').style.display = 'none';
            
            // Í≤åÏûÑ ÏòÅÏó≠ Ïà®Í∏∞Í∏∞
            document.getElementById('gameArea').style.display = 'none';
            
            // Ïó≠Ìï† ÏÑ†ÌÉù Ï∞Ω Îã§Ïãú ÌëúÏãú
            document.querySelector('.role-selection').style.display = 'block';
            
            // ÍµêÏÇ¨/ÌïôÏÉù Ìå®ÎÑê Ïà®Í∏∞Í∏∞
            document.getElementById('teacherPanel').style.display = 'none';
            document.getElementById('studentPanel').style.display = 'none';
            
            // Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
            currentGameState = null;
            selectedRole = null;
            selectedCategory = null;
            roomCode = null;
            customWords = [];
            
            showMessage('ÏÉàÎ°úÏö¥ Í≤åÏûÑÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî.', 'warning');
        }

        // Í≤åÏûÑ Ï¢ÖÎ£å Î™®Îã¨ Îã´Í∏∞ (ÌòÑÏû¨ Í≤åÏûÑ Í≥ÑÏÜç)
        function closeGameEndModalAndContinue() {
            document.getElementById('gameEndModal').style.display = 'none';
            // ÌòÑÏû¨ Í≤åÏûÑ ÌôîÎ©¥ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ
        }

        // Î™®Îì† Î¨∏Ï†ú ÏôÑÎ£å Ïãú ÏµúÏ¢Ö Ï†êÏàò Ï∞Ω ÌëúÏãú
        function showCompletionModal(message, finalScore) {
            const modal = document.getElementById('gameEndModal');
            const title = document.getElementById('gameEndTitle');
            const yesButton = document.getElementById('yesButton');
            const noButton = document.getElementById('noButton');
            
            title.textContent = 'üéâ Î™®Îì† Î¨∏Ï†ú ÏôÑÎ£å!';
            yesButton.textContent = 'ÏÉàÎ°úÏö¥ Í≤åÏûÑ';
            noButton.textContent = 'Í≤åÏûÑ Ï¢ÖÎ£å';
            
            modal.style.display = 'block';
            document.getElementById('gameEndMessage').textContent = message;
            
            currentGameState = null;
            updateDisplay();
        }

        // Enter ÌÇ§ Ïù¥Î≤§Ìä∏
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processInput();
            }
        });

        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        document.getElementById('quizModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        document.getElementById('gameOverModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        document.getElementById('gameEndModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // Ï∫êÎ¶≠ÌÑ∞Î•º Î≥¥Î¨º ÏúÑÏπòÎ°ú Ï¶âÏãú Ïù¥Îèô
        function moveCharacterToTreasure() {
            if (!currentGameState) return;
            
            const characterOverlay = document.getElementById('characterOverlay');
            const bridgeImage = document.getElementById('bridgeImage');
            
            if (!characterOverlay || !bridgeImage) return;
            
            // Ï∫êÎ¶≠ÌÑ∞Î•º Î≥¥Î¨º ÏúÑÏπòÎ°ú Ï¶âÏãú Ïù¥Îèô
            const bridgeWidth = bridgeImage.offsetWidth;
            const characterWidth = 100;
            const maxPosition = bridgeWidth - characterWidth;
            
            // Î≥¥Î¨º ÏúÑÏπòÎ°ú Ïù¥Îèô (Îã®Ïñ¥ Í∏∏Ïù¥ÎßåÌÅº Ïù¥Îèô)
            const leftPosition = Math.max(0, Math.min(maxPosition, maxPosition));
            
            characterOverlay.style.left = leftPosition + 'px';
        }

        // +1Ï†ê ÌëúÏãú
        function showScorePoint() {
            const treasureScore = document.getElementById('treasureScore');
            if (treasureScore) {
                treasureScore.style.display = 'block';
                treasureScore.textContent = '+1Ï†ê';
                
                // 3Ï¥à ÌõÑ Ïà®Í∏∞Í∏∞
                setTimeout(() => {
                    treasureScore.style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html> 